# 日志结构

<cite>
**本文档引用的文件**
- [testrunner.tcl](file://test/testrunner.tcl)
- [testrunner.md](file://doc/testrunner.md)
</cite>

## 目录
1. [简介](#简介)
2. [日志文件格式](#日志文件格式)
3. [日志条目与数据库记录的对应关系](#日志条目与数据库记录的对应关系)
4. [日志输出示例](#日志输出示例)
5. [日志编码与换行约定](#日志编码与换行约定)

## 简介
`testrunner.log` 文件是 SQLite 项目中由 `testrunner.tcl` 脚本生成的测试日志文件，用于记录并行执行的测试任务的详细输出。该日志文件与 `testrunner.db` 数据库协同工作，前者存储测试的原始输出内容，后者则以结构化方式存储每个测试任务的元数据和状态。本文档详细说明了 `testrunner.log` 文件的格式、结构以及其与数据库的关联。

**Section sources**
- [testrunner.tcl](file://test/testrunner.tcl#L220-L221)
- [testrunner.md](file://doc/testrunner.md#L1-L20)

## 日志文件格式
`testrunner.log` 文件中的每一行记录都遵循特定的结构，主要由分隔符、任务标识、状态标记和输出内容组成。

### 分隔符与任务标识
日志文件使用 `###` 作为分隔符，标记每个独立测试任务的开始。紧随其后的是任务的显示名称（`displayname`），该名称在 `testrunner.db` 的 `jobs` 表中定义，用于标识具体的测试任务。

### 状态标记
在任务标识之后，会记录任务的执行时长（以毫秒为单位）和最终状态。状态通常为 `done`（成功）或 `failed`（失败）。`!` 符号并非直接出现在 `testrunner.log` 的分隔行中，而是作为 `grep` 命令的搜索模式，用于在日志的输出内容中快速定位错误信息。根据文档，推荐使用 `grep "^!" testrunner.log` 来搜索错误。

### 输出内容的组织方式
在任务标识行之后，紧接着的是该任务执行过程中产生的所有标准输出和标准错误内容。这些内容被完整地捕获并写入日志文件，直到任务结束。多行输出的连续性通过在内存中累积输出流来保证，当任务完成时，累积的输出内容会被一次性写入日志文件。

**Section sources**
- [testrunner.tcl](file://test/testrunner.tcl#L1562-L1563)
- [testrunner.md](file://doc/testrunner.md#L30-L35)

## 日志条目与数据库记录的对应关系
`testrunner.log` 文件中的日志条目与 `testrunner.db` 数据库中的 `jobs` 表记录存在明确的对应关系。

### jobs 表结构
`jobs` 表是 `testrunner.db` 的核心，它为每个待执行的测试任务存储一行记录。关键字段包括：
- `jobid`: 任务的唯一标识符。
- `displayname`: 任务的显示名称，直接对应日志中的任务标识。
- `cmd`: 执行该任务的 shell 命令。
- `state`: 任务的当前状态（如 `ready`, `running`, `done`, `failed`）。
- `output`: 该字段存储了任务的完整输出内容，与 `testrunner.log` 文件中对应任务的输出部分完全一致。

### 对应机制
当一个测试任务完成时，`testrunner.tcl` 脚本会执行 `mark_job_as_finished` 过程。该过程会将内存中累积的任务输出（`$O($iJob)`）作为 `output` 字段的值，更新到 `jobs` 表中对应 `jobid` 的记录里。同时，它也会将任务的最终状态、执行时间、错误数量等信息一并更新。因此，`testrunner.log` 文件可以看作是所有 `jobs` 表记录中 `output` 字段的串联和可视化呈现。

**Section sources**
- [testrunner.tcl](file://test/testrunner.tcl#L308-L365)
- [testrunner.tcl](file://test/testrunner.tcl#L1562-L1563)
- [testrunner.tcl](file://test/testrunner.tcl#L1489-L1532)

## 日志输出示例
以下是 `testrunner.log` 文件中可能出现的日志片段示例。

### 正常执行情况
```
### Build: Win32-DLL 1234ms (done)
Splitting the library into multiple files...
All files generated successfully.
```
此示例显示了一个名为 "Build: Win32-DLL" 的构建任务成功完成，耗时 1234 毫秒。其后的两行是该任务执行过程中的正常输出。

### 错误情况
```
### Fuzz Test: Large Dataset 5678ms (failed)
Fuzzcheck found a crash in sqlite3_step() at line 1234.
Reproduction steps: ...
! ERROR: Test failed with code 1
```
此示例显示一个模糊测试任务失败。输出内容中包含了详细的错误信息，并且以 `!` 开头的行明确标示了错误，便于通过 `grep` 命令快速检索。

**Section sources**
- [testrunner.tcl](file://test/testrunner.tcl#L1562-L1563)
- [testrunner.md](file://doc/testrunner.md#L30-L35)

## 日志编码与换行约定
`testrunner.log` 文件采用标准的文本编码和换行约定。

### 编码格式
日志文件默认使用 UTF-8 编码。这确保了日志能够正确处理包含非 ASCII 字符的输出，例如来自不同语言环境的错误消息或文件路径。

### 换行符约定
换行符的约定取决于运行 `testrunner.tcl` 脚本的操作系统：
- 在 **Unix/Linux/macOS** 系统上，使用 **LF** (`\n`) 作为换行符。
- 在 **Windows** 系统上，使用 **CRLF** (`\r\n`) 作为换行符。

这种约定是由 Tcl 的 `puts` 命令和底层操作系统的文本模式 I/O 决定的。`fconfigure $fd -translation binary` 的设置确保了在读取子进程输出时，不会对换行符进行不必要的转换，从而保证了原始输出的完整性。

**Section sources**
- [testrunner.tcl](file://test/testrunner.tcl#L1637-L1638)
- [testrunner.tcl](file://test/testrunner.tcl#L1563)